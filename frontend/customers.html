<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kunden ‚Äì Lineage Explorer</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      --surface: rgba(255,255,255,0.05);
      --surface-hover: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.1);
      --accent: #667eea;
      --accent2: #764ba2;
      --text: #fff;
      --text-muted: rgba(255,255,255,0.5);
      --text-dim: rgba(255,255,255,0.3);
      --success: #22c55e;
      --error: #ef4444;
      --radius: 14px;
      --radius-sm: 8px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { min-height: 100vh; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); }

    nav { position: sticky; top: 0; z-index: 100; background: rgba(15,20,40,0.7); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 0 1.5rem; height: 60px; display: flex; align-items: center; gap: 1rem; }
    .nav-brand { display: flex; align-items: center; gap: 0.6rem; font-weight: 700; font-size: 1.05rem; text-decoration: none; color: var(--text); }
    .brand-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
    .nav-links { display: flex; gap: 0.25rem; margin-left: 1rem; }
    .nav-link { color: var(--text-muted); text-decoration: none; font-size: 0.875rem; padding: 0.4rem 0.75rem; border-radius: var(--radius-sm); transition: color 0.15s, background 0.15s; }
    .nav-link:hover { color: var(--text); background: var(--surface-hover); }
    .nav-link.active { color: var(--accent); background: var(--surface-hover); }
    .nav-spacer { flex: 1; }
    .nav-user { display: flex; align-items: center; gap: 0.75rem; }
    .nav-user-email { color: var(--text-muted); font-size: 0.8rem; }
    .btn-sm { padding: 0.4rem 0.9rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-muted); font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
    .btn-sm:hover { background: var(--surface-hover); color: var(--text); border-color: rgba(255,255,255,0.2); }

    main { max-width: 1000px; margin: 0 auto; padding: 2rem 1.5rem; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; }
    .page-title { font-size: 1.6rem; font-weight: 700; margin-bottom: 0.25rem; }
    .page-subtitle { color: var(--text-muted); font-size: 0.9rem; }

    .btn-primary { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.6rem 1.2rem; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; border: none; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-danger { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.35); color: #f87171; border-radius: var(--radius-sm); font-size: 0.78rem; padding: 0.3rem 0.65rem; cursor: pointer; transition: all 0.15s; }
    .btn-danger:hover { background: rgba(239,68,68,0.35); }
    .btn-edit { background: rgba(102,126,234,0.15); border: 1px solid rgba(102,126,234,0.3); color: #a5b4fc; border-radius: var(--radius-sm); font-size: 0.78rem; padding: 0.3rem 0.65rem; cursor: pointer; transition: all 0.15s; }
    .btn-edit:hover { background: rgba(102,126,234,0.3); }

    /* ‚îÄ‚îÄ TABLE CARD ‚îÄ‚îÄ */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); backdrop-filter: blur(10px); overflow: hidden; }
    .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border); }
    td { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.875rem; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface-hover); }
    .td-name { font-weight: 600; }
    .td-url { color: var(--text-muted); font-family: monospace; font-size: 0.8rem; max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .td-key { color: var(--text-dim); font-family: monospace; font-size: 0.8rem; }
    .td-notes { color: var(--text-muted); font-size: 0.8rem; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .td-actions { display: flex; gap: 0.4rem; justify-content: flex-end; white-space: nowrap; }

    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-dim); }
    .empty-icon { font-size: 2.5rem; opacity: 0.3; margin-bottom: 0.75rem; }
    .empty-msg { font-size: 0.9rem; line-height: 1.5; }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; }
    .modal-backdrop.open { display: flex; }
    .modal { background: rgba(15,20,50,0.97); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; width: 100%; max-width: 480px; position: relative; box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
    .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.5rem; }
    .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); font-size: 1.1rem; cursor: pointer; }
    .modal-close:hover { color: var(--text); }
    .form-group { margin-bottom: 1.1rem; }
    label { display: block; color: rgba(255,255,255,0.7); font-size: 0.82rem; font-weight: 500; margin-bottom: 0.45rem; letter-spacing: 0.03em; }
    input[type="text"], input[type="url"], input[type="password"], textarea { width: 100%; padding: 0.7rem 0.9rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: #fff; font-size: 0.9rem; outline: none; transition: border-color 0.2s; font-family: inherit; }
    input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.3); }
    input:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 80px; }
    .hint { color: rgba(255,255,255,0.35); font-size: 0.75rem; margin-top: 0.3rem; }
    .modal-footer { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
    .btn-modal-cancel { padding: 0.6rem 1.1rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-muted); font-size: 0.875rem; cursor: pointer; transition: all 0.15s; }
    .btn-modal-cancel:hover { background: var(--surface-hover); color: var(--text); }
    .btn-modal-save { padding: 0.6rem 1.3rem; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; border: none; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .btn-modal-save:hover { opacity: 0.9; }
    .btn-modal-save:disabled { opacity: 0.5; cursor: not-allowed; }

    .alert { border-radius: var(--radius-sm); padding: 0.65rem 0.9rem; font-size: 0.85rem; margin-bottom: 1rem; display: none; }
    .alert-error { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.35); color: #fca5a5; }
    .alert-success { background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.35); color: #86efac; }

    /* ‚îÄ‚îÄ CONFIRM DIALOG ‚îÄ‚îÄ */
    .confirm-modal { max-width: 380px; }
    .confirm-msg { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; line-height: 1.5; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: rgba(30,40,70,0.95); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--text); backdrop-filter: blur(10px); opacity: 0; transform: translateY(10px); transition: opacity 0.2s, transform 0.2s; pointer-events: none; max-width: 320px; z-index: 300; }
    #toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body>

<nav>
  <a class="nav-brand" href="/"><div class="brand-icon">‚¨°</div>Lineage Explorer</a>
  <div class="nav-links">
    <a class="nav-link" href="/">Dashboard</a>
    <a class="nav-link active" href="/customers.html">Kunden</a>
    <a class="nav-link" href="/projects.html">Projekte</a>
    <a class="nav-link" href="/lineage.html">Lineage</a>
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-user">
    <span class="nav-user-email" id="userEmail">‚Äî</span>
    <button class="btn-sm" id="logoutBtn">Sign out</button>
  </div>
</nav>

<main>
  <div class="page-header">
    <div>
      <h1 class="page-title">Kunden</h1>
      <p class="page-subtitle">Qlik Cloud Tenants verwalten</p>
    </div>
    <button class="btn-primary" id="newCustomerBtn">+ Neuer Kunde</button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="card-title">Alle Kunden</span>
      <span id="customerCount" style="font-size:0.8rem;color:var(--text-dim)">‚Äî</span>
    </div>
    <div id="tableWrap">
      <div class="empty-state">
        <div class="empty-icon">üè¢</div>
        <div class="empty-msg">Noch keine Kunden angelegt.<br>Klicke auf ‚ÄûNeuer Kunde" um zu beginnen.</div>
      </div>
    </div>
  </div>
</main>

<!-- Create / Edit Modal -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <button class="modal-close" id="modalClose">‚úï</button>
    <div class="modal-title" id="modalTitle">Neuer Kunde</div>
    <div class="alert alert-error" id="modalError"></div>
    <form id="customerForm">
      <input type="hidden" id="editingId" value="" />
      <div class="form-group">
        <label for="fName">Name *</label>
        <input id="fName" type="text" placeholder="Kundenname" required />
      </div>
      <div class="form-group">
        <label for="fUrl">Tenant URL *</label>
        <input id="fUrl" type="url" placeholder="https://your-tenant.us.qlikcloud.com" required spellcheck="false" />
      </div>
      <div class="form-group">
        <label for="fKey" id="fKeyLabel">API Key *</label>
        <input id="fKey" type="password" placeholder="Qlik Cloud API Key" spellcheck="false" autocomplete="new-password" />
        <p class="hint" id="fKeyHint">Eingabe erforderlich</p>
      </div>
      <div class="form-group">
        <label for="fNotes">Notizen</label>
        <textarea id="fNotes" placeholder="Optionale Notizen zum Kunden‚Ä¶"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal-cancel" id="modalCancel">Abbrechen</button>
        <button type="submit" class="btn-modal-save" id="modalSave">Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal-backdrop" id="confirmModal">
  <div class="modal confirm-modal">
    <div class="modal-title">Kunde l√∂schen?</div>
    <div class="confirm-msg" id="confirmMsg">Dieser Kunde und alle zugeh√∂rigen Projekte werden unwiderruflich gel√∂scht.</div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" id="confirmCancel">Abbrechen</button>
      <button class="btn-modal-save" id="confirmOk" style="background:linear-gradient(135deg,#ef4444,#dc2626)">L√∂schen</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
  var token = localStorage.getItem('auth_access_token');
  if (!token) { window.location.href = '/login.html'; }

  try {
    var jp = JSON.parse(atob(token.split('.')[1]));
    document.getElementById('userEmail').textContent = 'User #' + (jp.sub || '‚Äî');
  } catch(e) {}

  document.getElementById('logoutBtn').addEventListener('click', function() {
    localStorage.removeItem('auth_access_token');
    window.location.href = '/login.html';
  });

  function showToast(msg, dur) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, dur || 3000);
  }

  async function apiFetch(path, opts) {
    var headers = Object.assign({'Authorization': 'Bearer ' + token}, (opts && opts.headers) || {});
    var res = await fetch(path, Object.assign({}, opts || {}, {headers: headers}));
    if (res.status === 401) { localStorage.removeItem('auth_access_token'); window.location.href = '/login.html'; }
    return res;
  }

  function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ‚îÄ‚îÄ Load customers ‚îÄ‚îÄ
  var customers = [];

  async function loadCustomers() {
    try {
      var res = await apiFetch('/api/customers');
      customers = await res.json();
      renderTable();
    } catch(e) {
      showToast('Fehler beim Laden der Kunden');
    }
  }

  function renderTable() {
    var wrap = document.getElementById('tableWrap');
    document.getElementById('customerCount').textContent = customers.length + ' Kunde' + (customers.length !== 1 ? 'n' : '');

    if (!customers.length) {
      wrap.innerHTML = '<div class="empty-state"><div class="empty-icon">üè¢</div><div class="empty-msg">Noch keine Kunden angelegt.<br>Klicke auf ‚ÄûNeuer Kunde" um zu beginnen.</div></div>';
      return;
    }
    var rows = customers.map(function(c) {
      return '<tr>'
        + '<td class="td-name">' + escHtml(c.name) + '</td>'
        + '<td class="td-url" title="' + escHtml(c.tenant_url) + '">' + escHtml(c.tenant_url) + '</td>'
        + '<td class="td-key">' + escHtml(c.api_key_preview) + '</td>'
        + '<td class="td-notes" title="' + escHtml(c.notes || '') + '">' + escHtml(c.notes || '‚Äî') + '</td>'
        + '<td><div class="td-actions">'
        + '<button class="btn-edit" onclick="openEdit(' + c.id + ')">Bearbeiten</button>'
        + '<button class="btn-danger" onclick="openDelete(' + c.id + ', \'' + escHtml(c.name) + '\')">L√∂schen</button>'
        + '</div></td>'
        + '</tr>';
    }).join('');
    wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Tenant URL</th><th>API Key</th><th>Notizen</th><th style="text-align:right">Aktionen</th></tr></thead><tbody>' + rows + '</tbody></table>';
  }

  // ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function resetForm() {
    document.getElementById('editingId').value = '';
    document.getElementById('fName').value = '';
    document.getElementById('fUrl').value = '';
    document.getElementById('fKey').value = '';
    document.getElementById('fNotes').value = '';
    document.getElementById('modalError').style.display = 'none';
    document.getElementById('fKey').required = true;
    document.getElementById('fKeyLabel').textContent = 'API Key *';
    document.getElementById('fKeyHint').textContent = 'Eingabe erforderlich';
    document.getElementById('modalTitle').textContent = 'Neuer Kunde';
    document.getElementById('modalSave').disabled = false;
    document.getElementById('modalSave').textContent = 'Speichern';
  }

  document.getElementById('newCustomerBtn').addEventListener('click', function() { resetForm(); openModal('editModal'); });
  document.getElementById('modalClose').addEventListener('click', function() { closeModal('editModal'); });
  document.getElementById('modalCancel').addEventListener('click', function() { closeModal('editModal'); });
  document.getElementById('editModal').addEventListener('click', function(e) { if (e.target === this) closeModal('editModal'); });

  function openEdit(id) {
    var c = customers.find(function(x) { return x.id === id; });
    if (!c) return;
    resetForm();
    document.getElementById('editingId').value = String(id);
    document.getElementById('fName').value = c.name;
    document.getElementById('fUrl').value = c.tenant_url;
    document.getElementById('fNotes').value = c.notes || '';
    document.getElementById('fKey').required = false;
    document.getElementById('fKeyLabel').textContent = 'API Key';
    document.getElementById('fKeyHint').textContent = 'Leer lassen = bestehenden Key behalten';
    document.getElementById('modalTitle').textContent = 'Kunde bearbeiten';
    openModal('editModal');
  }

  // ‚îÄ‚îÄ Save ‚îÄ‚îÄ
  document.getElementById('customerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    var errorEl = document.getElementById('modalError');
    errorEl.style.display = 'none';
    var saveBtn = document.getElementById('modalSave');
    var editingId = document.getElementById('editingId').value;
    var name = document.getElementById('fName').value.trim();
    var tenantUrl = document.getElementById('fUrl').value.trim();
    var apiKey = document.getElementById('fKey').value.trim();
    var notes = document.getElementById('fNotes').value.trim() || null;

    if (!editingId && !apiKey) {
      errorEl.textContent = 'API Key ist beim Erstellen erforderlich.';
      errorEl.style.display = 'block';
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = '‚è≥ Speichern‚Ä¶';

    try {
      var url, method, body;
      if (editingId) {
        url = '/api/customers/' + editingId;
        method = 'PUT';
        body = {name: name, tenant_url: tenantUrl, notes: notes};
        if (apiKey) body.api_key = apiKey;
      } else {
        url = '/api/customers';
        method = 'POST';
        body = {name: name, tenant_url: tenantUrl, api_key: apiKey, notes: notes};
      }

      var res = await apiFetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        var err = await res.json().catch(function(){ return {}; });
        throw new Error(err.detail || 'Fehler beim Speichern');
      }
      closeModal('editModal');
      showToast('‚úì Kunde gespeichert');
      await loadCustomers();
    } catch(err) {
      errorEl.textContent = err.message;
      errorEl.style.display = 'block';
    }
    saveBtn.disabled = false;
    saveBtn.textContent = 'Speichern';
  });

  // ‚îÄ‚îÄ Delete ‚îÄ‚îÄ
  var deleteTargetId = null;
  function openDelete(id, name) {
    deleteTargetId = id;
    document.getElementById('confirmMsg').textContent = 'Kunde "' + name + '" und alle zugeh√∂rigen Projekte und Lineage-Daten werden unwiderruflich gel√∂scht.';
    openModal('confirmModal');
  }
  document.getElementById('confirmCancel').addEventListener('click', function() { closeModal('confirmModal'); });
  document.getElementById('confirmModal').addEventListener('click', function(e) { if (e.target === this) closeModal('confirmModal'); });
  document.getElementById('confirmOk').addEventListener('click', async function() {
    if (!deleteTargetId) return;
    this.disabled = true;
    this.textContent = '‚è≥ L√∂schen‚Ä¶';
    try {
      var res = await apiFetch('/api/customers/' + deleteTargetId, {method: 'DELETE'});
      if (!res.ok && res.status !== 204) throw new Error('Fehler beim L√∂schen');
      closeModal('confirmModal');
      showToast('‚úì Kunde gel√∂scht');
      await loadCustomers();
    } catch(e) {
      showToast('Fehler: ' + e.message);
    }
    this.disabled = false;
    this.textContent = 'L√∂schen';
    deleteTargetId = null;
  });

  loadCustomers();
</script>
</body>
</html>
