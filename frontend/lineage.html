<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lineage – Lineage Explorer</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      --surface: rgba(255,255,255,0.05);
      --surface-hover: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.1);
      --accent: #667eea;
      --accent2: #764ba2;
      --text: #fff;
      --text-muted: rgba(255,255,255,0.5);
      --text-dim: rgba(255,255,255,0.3);
      --radius: 14px;
      --radius-sm: 8px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      height: 100vh;
      overflow: hidden;
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    /* ── NAV ── */
    nav {
      flex-shrink: 0;
      position: relative;
      z-index: 100;
      background: rgba(15,20,40,0.7);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 0 1.5rem;
      height: 60px;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .nav-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 700;
      font-size: 1.05rem;
      text-decoration: none;
      color: var(--text);
    }
    .brand-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
    }
    .nav-links { display: flex; gap: 0.25rem; margin-left: 1rem; }
    .nav-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.875rem;
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius-sm);
      transition: color 0.15s, background 0.15s;
    }
    .nav-link:hover { color: var(--text); background: var(--surface-hover); }
    .nav-link.active { color: var(--accent); background: var(--surface-hover); }
    .nav-spacer { flex: 1; }
    .nav-user { display: flex; align-items: center; gap: 0.75rem; }
    .nav-user-email { color: var(--text-muted); font-size: 0.8rem; }
    .btn-sm {
      padding: 0.4rem 0.9rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-sm:hover { background: var(--surface-hover); color: var(--text); border-color: rgba(255,255,255,0.2); }

    /* ── TOOLBAR ── */
    .toolbar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1.5rem;
      background: rgba(10,15,35,0.6);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .toolbar-label { font-size: 0.8rem; color: var(--text-muted); }
    select {
      padding: 0.35rem 0.75rem;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 0.8rem;
      cursor: pointer;
      outline: none;
    }
    select:focus { border-color: var(--accent); }
    select option { background: #1a1a2e; color: #fff; }
    .toolbar-input {
      min-width: 190px;
      padding: 0.35rem 0.75rem;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 0.8rem;
      outline: none;
    }
    .toolbar-input:focus { border-color: var(--accent); }
    .toolbar-input::placeholder { color: var(--text-dim); }
    .btn-toolbar {
      padding: 0.35rem 0.9rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-toolbar:hover { background: var(--surface-hover); color: var(--text); }
    .btn-toolbar.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border-color: transparent;
    }
    .btn-toolbar.primary:hover { opacity: 0.9; }
    .stat-pill {
      padding: 0.2rem 0.6rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .stat-pill.warning {
      border-color: rgba(245, 158, 11, 0.65);
      color: #fbbf24;
      background: rgba(245, 158, 11, 0.1);
    }
    .toolbar-sep { width: 1px; height: 20px; background: var(--border); }

    /* ── GRAPH AREA ── */
    .graph-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    #graph-svg {
      width: 100%;
      height: 100%;
      cursor: grab;
    }
    #graph-svg:active { cursor: grabbing; }

    /* ── EMPTY STATE ── */
    #emptyState {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      pointer-events: none;
    }
    #emptyState.show { display: flex; }
    .empty-icon { font-size: 3rem; opacity: 0.3; }
    .empty-msg { color: var(--text-muted); font-size: 0.95rem; max-width: 320px; text-align: center; line-height: 1.5; }

    /* ── LOADING ── */
    #loadingOverlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,20,40,0.5);
      backdrop-filter: blur(4px);
      font-size: 1rem;
      color: var(--text-muted);
      gap: 0.75rem;
    }
    .spinner {
      width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── DETAIL PANEL ── */
    #detailPanel {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 280px;
      background: rgba(15,20,50,0.92);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      backdrop-filter: blur(16px);
      display: none;
      z-index: 50;
    }
    #detailPanel.show { display: block; }
    .detail-close {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }
    .detail-close:hover { color: var(--text); }
    .detail-type {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }
    .detail-label {
      font-size: 1.05rem;
      font-weight: 700;
      word-break: break-all;
      margin-bottom: 1rem;
      line-height: 1.3;
    }
    .detail-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.45rem;
      font-size: 0.8rem;
    }
    .detail-key { color: var(--text-muted); min-width: 70px; flex-shrink: 0; }
    .detail-val { color: var(--text); word-break: break-all; }

    /* ── LEGEND ── */
    #legend {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      background: rgba(15,20,50,0.88);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.75rem 1rem;
      backdrop-filter: blur(16px);
      font-size: 0.78rem;
    }
    .legend-title { color: var(--text-muted); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.7rem; }
    .legend-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--text-muted); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .legend-dot.out-of-area {
      width: 11px;
      height: 11px;
      background: transparent;
      border: 2px dashed #f59e0b;
    }
    .legend-desc { color: var(--text-muted); font-size: 0.76rem; }

    /* ── ZOOM CONTROLS ── */
    #zoomControls {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .zoom-btn {
      width: 32px; height: 32px;
      background: rgba(15,20,50,0.88);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-size: 1rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      backdrop-filter: blur(16px);
    }
    .zoom-btn:hover { background: var(--surface-hover); color: var(--text); }

    /* ── TOAST ── */
    #toast {
      position: fixed;
      bottom: 1.5rem;
      right: 4rem;
      background: rgba(30,40,70,0.95);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: var(--text);
      backdrop-filter: blur(10px);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      max-width: 320px;
      z-index: 200;
    }
    #toast.show { opacity: 1; transform: translateY(0); }

    /* ── ADMIN FAB ── */
  </style>
</head>
<body>

<nav>
  <a class="nav-brand" href="/">
    <div class="brand-icon">⬡</div>
    Lineage Explorer
  </a>
  <div class="nav-links">
    <a class="nav-link" href="/">Dashboard</a>
    <a class="nav-link" href="/projects.html">Projekte</a>
    <a class="nav-link active" href="/lineage.html">Lineage</a>
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-user">
    <span class="nav-user-email" id="userEmail">—</span>
    <button class="btn-sm" id="logoutBtn">Sign out</button>
  </div>
</nav>

<div class="toolbar">
  <span class="toolbar-label">Projekt:</span>
  <select id="projectSelect">
    <option value="">— alle —</option>
  </select>
  <div class="toolbar-sep"></div>
  <span class="toolbar-label">Typ:</span>
  <select id="typeFilter">
    <option value="">Alle</option>
    <option value="app">App</option>
    <option value="db">Database</option>
    <option value="table">Table</option>
    <option value="dataset">Dataset</option>
    <option value="qvd">QVD</option>
    <option value="file">File</option>
    <option value="other">Other</option>
  </select>
  <span class="toolbar-label">App:</span>
  <select id="appFilter">
    <option value="">Alle</option>
  </select>
  <span class="toolbar-label">Bereich:</span>
  <select id="areaFilter">
    <option value="">Alle</option>
  </select>
  <span class="toolbar-label">Ausserhalb:</span>
  <select id="outsideAreaMode">
    <option value="show">anzeigen</option>
    <option value="hide">ausblenden</option>
  </select>
  <span class="toolbar-label">Ansicht:</span>
  <select id="viewMode">
    <option value="force">Force Graph</option>
    <option value="tidy">Tidy Tree</option>
  </select>
  <input id="searchInput" class="toolbar-input" type="text" placeholder="Suche nach Name, ID, App, Bereich..." />
  <div class="toolbar-sep"></div>
  <button class="btn-toolbar primary" id="loadBtn">↻ Graph laden</button>
  <button class="btn-toolbar" id="resetViewBtn">⤢ Einpassen</button>
  <button class="btn-toolbar" id="resetLayoutBtn">Layout Reset</button>
  <div class="toolbar-sep"></div>
  <span class="stat-pill" id="nodeCount">0 Nodes</span>
  <span class="stat-pill" id="edgeCount">0 Edges</span>
  <span class="stat-pill warning" id="outAreaCount" style="display:none;">0 App(s) ausserhalb Bereich</span>
</div>

<div class="graph-wrap">
  <svg id="graph-svg">
    <defs>
      <marker id="arrow" viewBox="0 0 10 10" refX="20" refY="5"
              markerWidth="6" markerHeight="6" orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(255,255,255,0.3)" />
      </marker>
    </defs>
    <g id="graph-root">
      <g id="edges-layer"></g>
      <g id="nodes-layer"></g>
    </g>
  </svg>

  <div id="emptyState">
    <div class="empty-icon">⬡</div>
    <div class="empty-msg">No graph data found. Configure a customer with Qlik credentials under Kunden and start a data fetch from the Projekte page.</div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    Loading graph…
  </div>

  <!-- Node detail panel -->
  <div id="detailPanel">
    <button class="detail-close" id="detailClose">✕</button>
    <div class="detail-type" id="detailType">—</div>
    <div class="detail-label" id="detailLabel">—</div>
    <div id="detailRows"></div>
  </div>

  <!-- Legend -->
  <div id="legend">
    <div class="legend-title">Node types</div>
    <div class="legend-item"><div class="legend-dot" style="background:#667eea"></div>App <span class="legend-desc">- Qlik Anwendung</span></div>
    <div class="legend-item"><div class="legend-dot" style="background:#14b8a6"></div>Database <span class="legend-desc">- Datenbankquelle</span></div>
    <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>Table <span class="legend-desc">- Tabelle/Entitaet</span></div>
    <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6"></div>Dataset <span class="legend-desc">- aufbereiteter Datensatz</span></div>
    <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>QVD <span class="legend-desc">- Qlik Data File</span></div>
    <div class="legend-item"><div class="legend-dot" style="background:#06b6d4"></div>File <span class="legend-desc">- externe Datei</span></div>
    <div class="legend-item"><div class="legend-dot" style="background:#6b7280"></div>Other <span class="legend-desc">- sonstiger Knoten</span></div>
    <div class="legend-item"><div class="legend-dot out-of-area"></div>App ausserhalb Bereichsfilter</div>
  </div>

  <!-- Zoom controls -->
  <div id="zoomControls">
    <button class="zoom-btn" id="zoomIn" title="Zoom in">+</button>
    <button class="zoom-btn" id="zoomOut" title="Zoom out">−</button>
  </div>
</div>

<div id="toast"></div>

<!-- D3 v7 from CDN -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
  var token = localStorage.getItem('auth_access_token');
  if (!token) { window.location.href = '/login.html'; }

  // User email from token
  try {
    var jwtPayload = JSON.parse(atob(token.split('.')[1]));
    document.getElementById('userEmail').textContent = jwtPayload.email || 'User #' + (jwtPayload.sub || '-');
  } catch (e) {}

  document.getElementById('logoutBtn').addEventListener('click', function() {
    localStorage.removeItem('auth_access_token');
    window.location.href = '/login.html';
  });

  function showToast(msg, duration) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, duration || 3000);
  }

  var nodeColors = {
    app: '#667eea',
    db: '#14b8a6',
    table: '#f59e0b',
    dataset: '#8b5cf6',
    qvd: '#ef4444',
    file: '#06b6d4',
    other: '#6b7280'
  };

  function nodeColor(type) { return nodeColors[type] || nodeColors.other; }
  function normalizedNodeType(type) {
    var t = String(type || '').toLowerCase();
    return nodeColors[t] ? t : 'other';
  }
  function nodeAppId(node) {
    return String((node && (node.group || node.appId || (node.meta && (node.meta.appId || node.meta.app_id)))) || '').trim();
  }
  function nodeAppName(node) {
    return String((node && ((node.meta && node.meta.appName) || (node.meta && node.meta.app_name) || (node.type === 'app' ? node.label : ''))) || '').trim();
  }
  function nodeSpaceId(node) {
    return String((node && ((node.meta && (node.meta.spaceId || node.meta.space_id)) || (node.type === 'app' ? node.group : ''))) || '').trim();
  }
  function nodeSpaceName(node) {
    return String((node && ((node.meta && (node.meta.spaceName || node.meta.space_name)) || (node.meta && node.meta.area) || '')) || '').trim();
  }
  function nodeAppFilterValue(node) {
    var appName = nodeAppName(node);
    var appId = nodeAppId(node);
    return String(appName || appId || '').trim().toLowerCase();
  }
  function nodeAreaFilterValue(node) {
    var spaceName = nodeSpaceName(node);
    var spaceId = nodeSpaceId(node);
    return String(spaceName || spaceId || '').trim().toLowerCase();
  }
  function nodeAreaValue(node) {
    return String(nodeSpaceName(node) || nodeSpaceId(node) || '').trim();
  }
  function isOutOfAreaApp(node, activeAreaFilterValue) {
    if (!activeAreaFilterValue) return false;
    if (normalizedNodeType(node && node.type) !== 'app') return false;
    return nodeAreaFilterValue(node) !== activeAreaFilterValue;
  }
  function baseNodeStrokeColor(node) {
    return node && node.__outOfAreaApp ? '#f59e0b' : '#fff';
  }
  function baseNodeStrokeOpacity(node) {
    return node && node.__outOfAreaApp ? 0.95 : 0.16;
  }
  function baseNodeStrokeWidth(node) {
    return node && node.__outOfAreaApp ? 2.6 : 1.5;
  }
  function baseNodeStrokeDasharray(node) {
    return node && node.__outOfAreaApp ? '4 2' : null;
  }
  function collectReachableNodeIds(seedIds, edges) {
    var seeds = Array.from(seedIds || []);
    if (!seeds.length) return new Set();
    var adj = Object.create(null);
    (edges || []).forEach(function(e) {
      var s = edgeNodeId(e.source);
      var t = edgeNodeId(e.target);
      if (!s || !t) return;
      if (!adj[s]) adj[s] = [];
      if (!adj[t]) adj[t] = [];
      adj[s].push(String(t));
      adj[t].push(String(s));
    });
    var visited = new Set();
    var queue = seeds.slice();
    queue.forEach(function(id) { visited.add(String(id)); });
    while (queue.length) {
      var cur = String(queue.shift());
      var nexts = adj[cur] || [];
      nexts.forEach(function(nid) {
        var id = String(nid);
        if (visited.has(id)) return;
        visited.add(id);
        queue.push(id);
      });
    }
    return visited;
  }
  function collectIntermediateNodesBetweenOutsideApps(outsideAppIds, edges) {
    var outsideList = Array.from(outsideAppIds || []).map(function(id) { return String(id); });
    if (outsideList.length < 2) return new Set();

    var adjacency = Object.create(null);
    (edges || []).forEach(function(e) {
      var s = edgeNodeId(e.source);
      var t = edgeNodeId(e.target);
      if (!s || !t) return;
      s = String(s);
      t = String(t);
      if (!adjacency[s]) adjacency[s] = [];
      if (!adjacency[t]) adjacency[t] = [];
      adjacency[s].push(t);
      adjacency[t].push(s);
    });

    var outsideSet = new Set(outsideList);
    var intermediate = new Set();

    for (var i = 0; i < outsideList.length; i++) {
      var source = outsideList[i];
      if (!adjacency[source]) continue;

      var queue = [source];
      var seen = Object.create(null);
      var prev = Object.create(null);
      seen[source] = true;
      prev[source] = null;

      while (queue.length) {
        var cur = queue.shift();
        var nexts = adjacency[cur] || [];
        for (var n = 0; n < nexts.length; n++) {
          var nextId = String(nexts[n]);
          if (seen[nextId]) continue;
          seen[nextId] = true;
          prev[nextId] = cur;
          queue.push(nextId);
        }
      }

      for (var j = i + 1; j < outsideList.length; j++) {
        var target = outsideList[j];
        if (!seen[target]) continue;

        var path = [];
        var cursor = target;
        while (cursor !== null && typeof cursor !== 'undefined') {
          path.push(cursor);
          if (cursor === source) break;
          cursor = prev[cursor];
        }
        if (!path.length || path[path.length - 1] !== source) continue;

        for (var k = 1; k < path.length - 1; k++) {
          var mid = String(path[k]);
          if (!outsideSet.has(mid)) intermediate.add(mid);
        }
      }
    }

    return intermediate;
  }
  function nodeSearchHaystack(node) {
    var parts = [node.id, node.label, node.type, node.group, node.layer, node.subtype, nodeAppId(node), nodeAppName(node), nodeSpaceId(node), nodeSpaceName(node)];
    if (node.meta && typeof node.meta === 'object') {
      try { parts.push(JSON.stringify(node.meta)); } catch (e) {}
    }
    return parts.map(function(v) { return String(v || '').toLowerCase(); }).join(' ');
  }
  function edgeNodeId(value) {
    return (value && typeof value === 'object') ? value.id : value;
  }
  function escHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  var FILTER_DEBOUNCE_MS = 120;
  var LAYOUT_STORAGE_KEY = 'lineage_layout_positions_v1';
  var simulation = null;
  var currentTransform = d3.zoomIdentity;
  var lastData = null;
  var autoFitPending = false;
  var isProgrammaticZoom = false;
  var filterDebounceTimer = null;
  var tidyExpandedByScope = Object.create(null);
  var layoutPositionsByScope = (function() {
    try {
      var raw = localStorage.getItem(LAYOUT_STORAGE_KEY);
      var parsed = raw ? JSON.parse(raw) : {};
      return (parsed && typeof parsed === 'object') ? parsed : {};
    } catch (e) {
      return {};
    }
  })();

  function persistLayoutPositions() {
    try { localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layoutPositionsByScope)); } catch (e) {}
  }
  function currentGraphScopeKey() {
    var projectId = document.getElementById('projectSelect').value || 'all';
    return 'project:' + String(projectId);
  }
  function scopedPinnedPositions() {
    var key = currentGraphScopeKey();
    if (!layoutPositionsByScope[key] || typeof layoutPositionsByScope[key] !== 'object') {
      layoutPositionsByScope[key] = {};
    }
    return layoutPositionsByScope[key];
  }
  function applyPinnedPositions(simNodes) {
    var pins = scopedPinnedPositions();
    simNodes.forEach(function(n) {
      var pin = pins[n.id];
      if (!pin || typeof pin.x !== 'number' || typeof pin.y !== 'number') return;
      n.x = pin.x;
      n.y = pin.y;
      n.fx = pin.x;
      n.fy = pin.y;
    });
  }
  function pinNodePosition(node) {
    if (!node || !node.id || typeof node.fx !== 'number' || typeof node.fy !== 'number') return;
    var pins = scopedPinnedPositions();
    pins[node.id] = { x: node.fx, y: node.fy };
    persistLayoutPositions();
  }
  function clearPinnedLayoutForCurrentScope() {
    delete layoutPositionsByScope[currentGraphScopeKey()];
    persistLayoutPositions();
  }
  function scopedTidyExpanded() {
    var key = currentGraphScopeKey();
    if (!tidyExpandedByScope[key] || typeof tidyExpandedByScope[key] !== 'object') {
      tidyExpandedByScope[key] = Object.create(null);
    }
    return tidyExpandedByScope[key];
  }
  function isTidyExpanded(nodeId) {
    var expanded = scopedTidyExpanded();
    return !!expanded[String(nodeId)];
  }
  function toggleTidyExpanded(nodeId) {
    var key = String(nodeId);
    if (!key) return;
    var expanded = scopedTidyExpanded();
    if (expanded[key]) delete expanded[key];
    else expanded[key] = true;
  }
  function setTidyExpanded(nodeId, shouldExpand) {
    var key = String(nodeId || '');
    if (!key) return;
    var expanded = scopedTidyExpanded();
    if (shouldExpand) expanded[key] = true;
    else delete expanded[key];
  }
  function clearTidyExpandedForCurrentScope() {
    delete tidyExpandedByScope[currentGraphScopeKey()];
  }
  function setSelectOptions(selectEl, values, placeholder) {
    var current = selectEl.value || '';
    var html = '<option value="">' + escHtml(placeholder || 'Alle') + '</option>';
    values.forEach(function(v) {
      var value = (v && typeof v === 'object') ? String(v.value || '') : String(v || '');
      var label = (v && typeof v === 'object') ? String(v.label || value) : value;
      html += '<option value="' + escHtml(value) + '"' + (value === current ? ' selected' : '') + '>' + escHtml(label) + '</option>';
    });
    selectEl.innerHTML = html;
    var allowedValues = values.map(function(v) { return (v && typeof v === 'object') ? String(v.value || '') : String(v || ''); });
    if (current && allowedValues.indexOf(current) === -1) {
      selectEl.value = '';
    }
  }
  function populateLineageFilters(data) {
    var rawNodes = (data && data.nodes) || [];
    var appSeen = Object.create(null);
    var areaSeen = Object.create(null);
    var appValues = [];
    var areaValues = [];

    rawNodes.forEach(function(n) {
      if (normalizedNodeType(n.type) !== 'app') return;
      var spaceId = nodeSpaceId(n);
      var spaceName = nodeSpaceName(n);
      var areaFilterVal = nodeAreaFilterValue(n);
      if (areaFilterVal && !areaSeen[areaFilterVal]) {
        areaSeen[areaFilterVal] = true;
        areaValues.push({
          value: areaFilterVal,
          label: spaceName ? (spaceId && spaceId !== spaceName ? (spaceName + ' (' + spaceId + ')') : spaceName) : spaceId
        });
      }
    });

    areaValues.sort(function(a, b) {
      return String(a.label || a.value).localeCompare(String(b.label || b.value));
    });
    setSelectOptions(document.getElementById('areaFilter'), areaValues, 'Alle');

    var selectedAreaFilter = String(document.getElementById('areaFilter').value || '').trim().toLowerCase();

    rawNodes.forEach(function(n) {
      if (normalizedNodeType(n.type) !== 'app') return;
      var appId = nodeAppId(n);
      var appName = nodeAppName(n);
      var appFilterVal = nodeAppFilterValue(n);
      var areaFilterVal = nodeAreaFilterValue(n);
      if (selectedAreaFilter && areaFilterVal !== selectedAreaFilter) return;
      if (appFilterVal && !appSeen[appFilterVal]) {
        appSeen[appFilterVal] = true;
        appValues.push({
          value: appFilterVal,
          label: appName ? (appId && appId !== appName ? (appName + ' (' + appId + ')') : appName) : appId
        });
      }
    });

    appValues.sort(function(a, b) {
      return String(a.label || a.value).localeCompare(String(b.label || b.value));
    });
    setSelectOptions(document.getElementById('appFilter'), appValues, 'Alle');
  }
  function maybeRenderLastData() {
    if (lastData) renderGraph(lastData);
  }
  function debounceRender() {
    if (filterDebounceTimer) clearTimeout(filterDebounceTimer);
    filterDebounceTimer = setTimeout(function() {
      filterDebounceTimer = null;
      maybeRenderLastData();
    }, FILTER_DEBOUNCE_MS);
  }

  var svg = d3.select('#graph-svg');
  var root = d3.select('#graph-root');
  var edgesLayer = d3.select('#edges-layer');
  var nodesLayer = d3.select('#nodes-layer');

  var zoom = d3.zoom()
    .scaleExtent([0.05, 4])
    .on('start', function(event) {
      if (!isProgrammaticZoom && event && event.sourceEvent) autoFitPending = false;
    })
    .on('zoom', function(event) {
      currentTransform = event.transform;
      root.attr('transform', event.transform);
    });
  svg.call(zoom);
  svg.on('dblclick.zoom', null);

  function applyZoomTransform(transform, durationMs) {
    isProgrammaticZoom = true;
    if (durationMs && durationMs > 0) {
      svg.transition().duration(durationMs).call(zoom.transform, transform);
      setTimeout(function() { isProgrammaticZoom = false; }, durationMs + 30);
    } else {
      svg.call(zoom.transform, transform);
      isProgrammaticZoom = false;
    }
  }

  function fitView(nodes) {
    if (!nodes || !nodes.length) return;
    var width = svg.node().clientWidth;
    var height = svg.node().clientHeight;
    var xs = nodes.map(function(n) { return n.x; }).filter(function(v) { return typeof v === 'number' && isFinite(v); });
    var ys = nodes.map(function(n) { return n.y; }).filter(function(v) { return typeof v === 'number' && isFinite(v); });
    if (!xs.length || !ys.length) return;
    var minX = d3.min(xs), maxX = d3.max(xs);
    var minY = d3.min(ys), maxY = d3.max(ys);
    var dx = maxX - minX || 1, dy = maxY - minY || 1;
    var scale = Math.min(0.9 * width / dx, 0.9 * height / dy, 2);
    var tx = width / 2 - scale * (minX + maxX) / 2;
    var ty = height / 2 - scale * (minY + maxY) / 2;
    applyZoomTransform(d3.zoomIdentity.translate(tx, ty).scale(scale), 450);
  }

  function buildTidyTree(simNodes, simLinks) {
    var nodeById = Object.create(null);
    (simNodes || []).forEach(function(n) {
      nodeById[String(n.id)] = n;
    });

    var rootApps = (simNodes || []).filter(function(n) {
      return normalizedNodeType(n.type) === 'app';
    }).sort(function(a, b) {
      var al = String(a.label || a.id || '');
      var bl = String(b.label || b.id || '');
      return al.localeCompare(bl);
    });

    var root = { id: '__root__', label: '__root__', node: null, children: [] };
    if (!rootApps.length) {
      return { root: root, crossEdges: [] };
    }

    var incomingByTarget = Object.create(null);
    var outgoingBySource = Object.create(null);
    (simLinks || []).forEach(function(e) {
      var sid = String(edgeNodeId(e.source) || '');
      var tid = String(edgeNodeId(e.target) || '');
      if (!sid || !tid) return;
      if (!nodeById[sid] || !nodeById[tid]) return;
      if (!incomingByTarget[tid]) incomingByTarget[tid] = [];
      if (!outgoingBySource[sid]) outgoingBySource[sid] = [];
      incomingByTarget[tid].push(sid);
      outgoingBySource[sid].push(tid);
    });
    Object.keys(incomingByTarget).forEach(function(id) {
      incomingByTarget[id] = Array.from(new Set(incomingByTarget[id]));
    });
    Object.keys(outgoingBySource).forEach(function(id) {
      outgoingBySource[id] = Array.from(new Set(outgoingBySource[id]));
    });

    function nodeSortKey(nodeId) {
      var n = nodeById[String(nodeId)] || {};
      return String(n.label || n.id || nodeId || '');
    }

    function sourceNeighbors(nodeId) {
      var id = String(nodeId || '');
      var incoming = incomingByTarget[id] || [];
      var outgoing = outgoingBySource[id] || [];
      var preferred = incoming;
      var fallback = outgoing;
      var chosen = preferred.length ? preferred : fallback;
      return chosen.slice().sort(function(a, b) {
        return nodeSortKey(a).localeCompare(nodeSortKey(b));
      });
    }

    var allCrossEdges = [];
    var allCrossEdgeSeen = Object.create(null);
    rootApps.forEach(function(appNode) {
      var rootId = String(appNode.id);
      var instancesByNodeId = Object.create(null);
      var parentByNodeId = Object.create(null);
      var rootCrossEdges = [];
      var rootCrossEdgeSeen = Object.create(null);

      function keyFor(nodeId) {
        return rootId + '::' + String(nodeId);
      }

      function getInstance(nodeId) {
        var id = String(nodeId || '');
        if (!id || !nodeById[id]) return null;
        if (!instancesByNodeId[id]) {
          var instanceKey = keyFor(id);
          instancesByNodeId[id] = {
            id: instanceKey,
            nodeId: id,
            rootNodeId: rootId,
            node: nodeById[id],
            hasChildren: false,
            expanded: isTidyExpanded(instanceKey),
            childNodeIds: [],
            children: []
          };
        } else {
          instancesByNodeId[id].expanded = isTidyExpanded(instancesByNodeId[id].id);
        }
        return instancesByNodeId[id];
      }

      function registerCrossEdge(fromNodeId, toNodeId) {
        var fromKey = keyFor(fromNodeId);
        var toKey = keyFor(toNodeId);
        var edgeKey = fromKey < toKey ? (fromKey + '::' + toKey) : (toKey + '::' + fromKey);
        if (rootCrossEdgeSeen[edgeKey]) return;
        rootCrossEdgeSeen[edgeKey] = true;
        rootCrossEdges.push({ source: fromKey, target: toKey });
      }

      function buildFrom(nodeId, pathVisitedIds) {
        var id = String(nodeId || '');
        var instance = getInstance(id);
        if (!instance) return null;

        var childIds = sourceNeighbors(id).filter(function(nextId) {
          return !pathVisitedIds.has(String(nextId));
        });
        instance.hasChildren = childIds.length > 0;
        instance.childNodeIds = childIds.slice();

        if (!instance.expanded || !childIds.length) return instance;

        childIds.forEach(function(childIdRaw) {
          var childId = String(childIdRaw);
          var childInstance = getInstance(childId);
          if (!childInstance) return;

          if (!parentByNodeId[childId]) {
            parentByNodeId[childId] = id;
            if (!instance.children.some(function(c) { return c.id === childInstance.id; })) {
              instance.children.push(childInstance);
            }
            var nextVisited = new Set(pathVisitedIds);
            nextVisited.add(childId);
            buildFrom(childId, nextVisited);
            return;
          }

          if (parentByNodeId[childId] === id) {
            var revisitVisited = new Set(pathVisitedIds);
            revisitVisited.add(childId);
            buildFrom(childId, revisitVisited);
            return;
          }

          registerCrossEdge(id, childId);
        });

        return instance;
      }

      var rootInstance = getInstance(rootId);
      if (!rootInstance) return;
      parentByNodeId[rootId] = '__root__';
      buildFrom(rootId, new Set([rootId]));
      root.children.push(rootInstance);

      rootCrossEdges.forEach(function(e) {
        var edgeKey = e.source < e.target ? (e.source + '::' + e.target) : (e.target + '::' + e.source);
        if (allCrossEdgeSeen[edgeKey]) return;
        allCrossEdgeSeen[edgeKey] = true;
        allCrossEdges.push(e);
      });
    });

    return { root: root, crossEdges: allCrossEdges };
  }

  function renderTidyTree(simNodes, simLinks, areaFilterValue, outsideAreaMode, hiddenOutOfAreaAppCount, hiddenBetweenOutsideCount) {
    if (simulation) {
      simulation.stop();
      simulation = null;
    }

    edgesLayer.selectAll('*').remove();
    nodesLayer.selectAll('*').remove();

    var tidy = buildTidyTree(simNodes, simLinks);
    var rootData = tidy.root || { children: [] };
    if (!rootData.children || !rootData.children.length) {
      document.getElementById('nodeCount').textContent = '0 nodes';
      document.getElementById('edgeCount').textContent = '0 edges';
      document.getElementById('outAreaCount').style.display = 'none';
      document.getElementById('emptyState').classList.add('show');
      return;
    }

    var hierarchy = d3.hierarchy(rootData, function(d) { return d.children; });
    d3.tree().nodeSize([62, 220])(hierarchy);

    var descendants = hierarchy.descendants().filter(function(d) {
      return d.data && d.data.id !== '__root__';
    });
    var treeLinksRaw = hierarchy.links().filter(function(l) {
      return l.source && l.source.data && l.source.data.id !== '__root__';
    });

    var positionedById = Object.create(null);
    var positionedNodes = descendants.map(function(d) {
      var baseNode = Object.assign({}, d.data.node || {});
      baseNode.id = String(d.data.nodeId || '');
      baseNode.x = d.y;
      baseNode.y = d.x;
      baseNode.__outOfAreaApp = isOutOfAreaApp(baseNode, areaFilterValue);
      baseNode.__tidyKey = String(d.data.id || '');
      baseNode.__tidyDepth = Number(d.depth || 0);
      baseNode.__tidyRootNodeId = String(d.data.rootNodeId || '');
      baseNode.__tidyHasChildren = !!d.data.hasChildren;
      baseNode.__tidyExpanded = !!d.data.expanded;
      baseNode.__tidyChildNodeIds = Array.isArray(d.data.childNodeIds) ? d.data.childNodeIds.slice() : [];
      positionedById[baseNode.__tidyKey] = baseNode;
      return baseNode;
    });

    var treeLinks = treeLinksRaw.map(function(l) {
      return {
        sourceKey: String(l.source.data.id),
        targetKey: String(l.target.data.id),
        source: { id: String(l.source.data.id), x: l.source.y, y: l.source.x },
        target: { id: String(l.target.data.id), x: l.target.y, y: l.target.x }
      };
    });

    var crossLinks = (tidy.crossEdges || []).map(function(e) {
      var s = positionedById[String(e.source)];
      var t = positionedById[String(e.target)];
      if (!s || !t) return null;
      return {
        source: { id: s.id, x: s.x, y: s.y },
        target: { id: t.id, x: t.x, y: t.y }
      };
    }).filter(function(v) { return !!v; });

    var linkGen = d3.linkHorizontal()
      .x(function(d) { return d.x; })
      .y(function(d) { return d.y; });

    var treeLink = edgesLayer.selectAll('path.tree-link')
      .data(treeLinks)
      .enter().append('path')
        .attr('class', 'tree-link')
        .attr('fill', 'none')
        .attr('stroke', 'rgba(255,255,255,0.24)')
        .attr('stroke-width', 1.5)
        .attr('d', function(d) { return linkGen(d); });

    var crossLink = edgesLayer.selectAll('path.cross-link')
      .data(crossLinks)
      .enter().append('path')
        .attr('class', 'cross-link')
        .attr('fill', 'none')
        .attr('stroke', 'rgba(245,158,11,0.45)')
        .attr('stroke-width', 1.2)
        .attr('stroke-dasharray', '3 3')
        .attr('d', function(d) { return linkGen(d); });

    var nodeGroup = nodesLayer.selectAll('g')
      .data(positionedNodes)
      .enter().append('g')
        .attr('class', function(d) { return d.__outOfAreaApp ? 'node node-out-of-area-app' : 'node'; })
        .style('cursor', 'pointer')
        .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
        .on('click', function(event, d) {
          if (d.__tidyHasChildren) {
            var nextExpanded = !isTidyExpanded(d.__tidyKey);
            setTidyExpanded(d.__tidyKey, nextExpanded);
            if (nextExpanded) {
              var sharedChildSet = new Set((d.__tidyChildNodeIds || []).map(function(cid) { return String(cid); }));
              positionedNodes.forEach(function(peer) {
                if (!peer || peer.__tidyKey === d.__tidyKey) return;
                if (!peer.__tidyHasChildren) return;
                if (peer.__tidyDepth !== d.__tidyDepth) return;
                if (peer.__tidyRootNodeId !== d.__tidyRootNodeId) return;
                var peerChildIds = peer.__tidyChildNodeIds || [];
                var sharesNextNode = peerChildIds.some(function(cid) { return sharedChildSet.has(String(cid)); });
                if (sharesNextNode) setTidyExpanded(peer.__tidyKey, true);
              });
            }
            if (lastData) renderGraph(lastData);
          } else {
            showDetail(d);
          }
          event.stopPropagation();
        });

    nodeGroup.append('circle')
      .attr('class', 'node-circle')
      .attr('r', 14)
      .attr('fill', function(d) { return nodeColor(d.type); })
      .attr('fill-opacity', 0.9)
      .attr('stroke', function(d) { return baseNodeStrokeColor(d); })
      .attr('stroke-opacity', function(d) { return baseNodeStrokeOpacity(d); })
      .attr('stroke-width', function(d) { return baseNodeStrokeWidth(d); })
      .attr('stroke-dasharray', function(d) { return baseNodeStrokeDasharray(d); });

    nodeGroup.filter(function(d) { return d.__outOfAreaApp; })
      .append('circle')
      .attr('r', 18)
      .attr('fill', 'none')
      .attr('stroke', '#f59e0b')
      .attr('stroke-opacity', 0.7)
      .attr('stroke-width', 1.4)
      .attr('stroke-dasharray', '3 2');

    var toggleGroup = nodeGroup.filter(function(d) { return d.__tidyHasChildren; })
      .append('g')
      .attr('class', 'tidy-toggle-indicator')
      .attr('transform', 'translate(12,-12)');

    toggleGroup.append('circle')
      .attr('r', 6.3)
      .attr('fill', 'rgba(15,20,50,0.95)')
      .attr('stroke', '#cbd5e1')
      .attr('stroke-opacity', 0.75)
      .attr('stroke-width', 1);

    toggleGroup.append('text')
      .text(function(d) { return d.__tidyExpanded ? '-' : '+'; })
      .attr('text-anchor', 'middle')
      .attr('dy', 3.3)
      .attr('font-size', '10px')
      .attr('font-weight', 700)
      .attr('fill', '#e2e8f0')
      .style('pointer-events', 'none');

    nodeGroup.append('text')
      .text(function(d) {
        var label = d.label || d.id || '';
        return label.length > 30 ? label.slice(0, 28) + '...' : label;
      })
      .attr('text-anchor', 'start')
      .attr('dx', 20)
      .attr('dy', 4)
      .attr('font-size', '10px')
      .attr('fill', 'rgba(255,255,255,0.72)')
      .style('pointer-events', 'none');

    function linkTouchesNode(linkDatum, nodeId) {
      return String(linkDatum.sourceKey) === String(nodeId) || String(linkDatum.targetKey) === String(nodeId);
    }

    nodeGroup
      .on('mouseenter', function(event, d) {
        d3.select(this).select('.node-circle')
          .attr('stroke', '#fff').attr('stroke-opacity', 0.95).attr('stroke-width', 2.2);

        treeLink
          .attr('stroke', function(l) { return linkTouchesNode(l, d.__tidyKey) ? 'rgba(102,126,234,0.72)' : 'rgba(255,255,255,0.10)'; })
          .attr('stroke-width', function(l) { return linkTouchesNode(l, d.__tidyKey) ? 2.2 : 1.1; });

        crossLink
          .attr('stroke', function(l) { return linkTouchesNode(l, d.__tidyKey) ? 'rgba(245,158,11,0.85)' : 'rgba(245,158,11,0.18)'; })
          .attr('stroke-width', function(l) { return linkTouchesNode(l, d.__tidyKey) ? 1.8 : 1.0; });
      })
      .on('mouseleave', function(event, d) {
        d3.select(this).select('.node-circle')
          .attr('stroke', function() { return baseNodeStrokeColor(d); })
          .attr('stroke-opacity', function() { return baseNodeStrokeOpacity(d); })
          .attr('stroke-width', function() { return baseNodeStrokeWidth(d); })
          .attr('stroke-dasharray', function() { return baseNodeStrokeDasharray(d); });

        treeLink
          .attr('stroke', 'rgba(255,255,255,0.24)')
          .attr('stroke-width', 1.5);

        crossLink
          .attr('stroke', 'rgba(245,158,11,0.45)')
          .attr('stroke-width', 1.2);
      });

    var outOfAreaAppCount = areaFilterValue
      ? positionedNodes.filter(function(n) { return n.__outOfAreaApp; }).length
      : 0;
    var outAreaCountEl = document.getElementById('outAreaCount');
    if (areaFilterValue && outsideAreaMode === 'hide' && (hiddenOutOfAreaAppCount > 0 || hiddenBetweenOutsideCount > 0)) {
      outAreaCountEl.textContent = hiddenOutOfAreaAppCount + ' App(s) ausserhalb + ' + hiddenBetweenOutsideCount + ' Zwischenknoten ausgeblendet';
      outAreaCountEl.style.display = 'inline-block';
    } else if (areaFilterValue && outOfAreaAppCount > 0) {
      outAreaCountEl.textContent = outOfAreaAppCount + ' App(s) ausserhalb Bereich';
      outAreaCountEl.style.display = 'inline-block';
    } else {
      outAreaCountEl.style.display = 'none';
    }

    document.getElementById('nodeCount').textContent = positionedNodes.length + ' nodes';
    document.getElementById('edgeCount').textContent = (treeLinks.length + crossLinks.length) + ' edges';
    document.getElementById('emptyState').classList.toggle('show', !positionedNodes.length);
    fitView(positionedNodes);
    svg.on('click', function() { closeDetail(); });
  }

  function renderGraph(data) {
    var rawNodes = (data && data.nodes) || [];
    var rawEdges = (data && data.edges) || [];
    var viewMode = document.getElementById('viewMode').value || 'force';
    var outsideAreaMode = document.getElementById('outsideAreaMode').value || 'show';
    var typeFilter = document.getElementById('typeFilter').value;
    var appFilter = document.getElementById('appFilter').value;
    var areaFilter = document.getElementById('areaFilter').value;
    var areaFilterValue = String(areaFilter || '').trim().toLowerCase();
    var searchTerm = (document.getElementById('searchInput').value || '').trim().toLowerCase();

    var baseVisibleNodeIds = null;
    if (appFilter || areaFilter) {
      var seedAppNodeIds = new Set(
        rawNodes.filter(function(n) {
          if (normalizedNodeType(n.type) !== 'app') return false;
          if (appFilter && nodeAppFilterValue(n) !== String(appFilter).toLowerCase()) return false;
          if (areaFilter && nodeAreaFilterValue(n) !== String(areaFilter).toLowerCase()) return false;
          return true;
        }).map(function(n) { return String(n.id); })
      );
      baseVisibleNodeIds = collectReachableNodeIds(seedAppNodeIds, rawEdges);
    }

    var filteredNodes = rawNodes.filter(function(n) {
      if (baseVisibleNodeIds && !baseVisibleNodeIds.has(String(n.id))) return false;
      if (typeFilter && normalizedNodeType(n.type) !== typeFilter) {
        if (!(viewMode === 'tidy' && normalizedNodeType(n.type) === 'app')) return false;
      }
      if (searchTerm && nodeSearchHaystack(n).indexOf(searchTerm) === -1) return false;
      return true;
    });

    var nodeIds = new Set(filteredNodes.map(function(n) { return String(n.id); }));
    var filteredEdges = rawEdges.filter(function(e) {
      return nodeIds.has(e.source) && nodeIds.has(e.target);
    });

    var hiddenOutOfAreaAppCount = 0;
    var hiddenBetweenOutsideCount = 0;
    if (areaFilterValue && outsideAreaMode === 'hide') {
      var outsideAppNodeIds = new Set(
        filteredNodes
          .filter(function(n) { return isOutOfAreaApp(n, areaFilterValue); })
          .map(function(n) { return String(n.id); })
      );
      hiddenOutOfAreaAppCount = outsideAppNodeIds.size;
      var betweenOutsideNodeIds = collectIntermediateNodesBetweenOutsideApps(outsideAppNodeIds, filteredEdges);
      hiddenBetweenOutsideCount = betweenOutsideNodeIds.size;

      if (hiddenOutOfAreaAppCount > 0 || hiddenBetweenOutsideCount > 0) {
        var excludedNodeIds = new Set();
        outsideAppNodeIds.forEach(function(id) { excludedNodeIds.add(id); });
        betweenOutsideNodeIds.forEach(function(id) { excludedNodeIds.add(String(id)); });

        filteredNodes = filteredNodes.filter(function(n) { return !excludedNodeIds.has(String(n.id)); });
        nodeIds = new Set(filteredNodes.map(function(n) { return String(n.id); }));
        filteredEdges = filteredEdges.filter(function(e) {
          return nodeIds.has(String(e.source)) && nodeIds.has(String(e.target));
        });
      }
    }

    var outOfAreaAppCount = areaFilterValue
      ? filteredNodes.filter(function(n) { return isOutOfAreaApp(n, areaFilterValue); }).length
      : 0;
    var outAreaCountEl = document.getElementById('outAreaCount');
    if (areaFilterValue && outsideAreaMode === 'hide' && (hiddenOutOfAreaAppCount > 0 || hiddenBetweenOutsideCount > 0)) {
      outAreaCountEl.textContent = hiddenOutOfAreaAppCount + ' App(s) ausserhalb + ' + hiddenBetweenOutsideCount + ' Zwischenknoten ausgeblendet';
      outAreaCountEl.style.display = 'inline-block';
    } else if (areaFilterValue && outOfAreaAppCount > 0) {
      outAreaCountEl.textContent = outOfAreaAppCount + ' App(s) ausserhalb Bereich';
      outAreaCountEl.style.display = 'inline-block';
    } else {
      outAreaCountEl.style.display = 'none';
    }

    document.getElementById('nodeCount').textContent = filteredNodes.length + ' nodes';
    document.getElementById('edgeCount').textContent = filteredEdges.length + ' edges';
    document.getElementById('emptyState').classList.toggle('show', !filteredNodes.length);

    var simNodes = filteredNodes.map(function(n) {
      var copy = Object.assign({}, n);
      copy.__outOfAreaApp = isOutOfAreaApp(copy, areaFilterValue);
      return copy;
    });
    var nodeMap = {};
    simNodes.forEach(function(n) { nodeMap[n.id] = n; });
    var simLinks = filteredEdges.map(function(e) {
      return { source: e.source, target: e.target, relation: e.relation, id: e.id };
    }).filter(function(e) { return nodeMap[e.source] && nodeMap[e.target]; });

    if (viewMode === 'tidy') {
      renderTidyTree(
        simNodes,
        simLinks,
        areaFilterValue,
        outsideAreaMode,
        hiddenOutOfAreaAppCount,
        hiddenBetweenOutsideCount
      );
      return;
    }

    if (simulation) simulation.stop();
    applyPinnedPositions(simNodes);

    var adjacency = Object.create(null);
    simLinks.forEach(function(e) {
      var sid = edgeNodeId(e.source);
      var tid = edgeNodeId(e.target);
      if (!sid || !tid) return;
      if (!adjacency[sid]) adjacency[sid] = Object.create(null);
      if (!adjacency[tid]) adjacency[tid] = Object.create(null);
      adjacency[sid][tid] = true;
      adjacency[tid][sid] = true;
    });

    var width = svg.node().clientWidth;
    var height = svg.node().clientHeight;

    simulation = d3.forceSimulation(simNodes)
      .force('link', d3.forceLink(simLinks).id(function(d) { return d.id; }).distance(80))
      .force('charge', d3.forceManyBody().strength(-210))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide(22));

    autoFitPending = true;

    edgesLayer.selectAll('*').remove();
    var link = edgesLayer.selectAll('line')
      .data(simLinks)
      .enter().append('line')
        .attr('stroke', 'rgba(255,255,255,0.18)')
        .attr('stroke-width', 1.5)
        .attr('marker-end', 'url(#arrow)');

    nodesLayer.selectAll('*').remove();

    function nudgeNeighbors(nodeId, dx, dy) {
      var neighbors = adjacency[nodeId];
      if (!neighbors) return;
      Object.keys(neighbors).forEach(function(neighborId) {
        var neighbor = nodeMap[neighborId];
        if (!neighbor) return;
        if (typeof neighbor.fx === 'number' && typeof neighbor.fy === 'number') return;
        neighbor.vx = (neighbor.vx || 0) + (dx || 0) * 0.12;
        neighbor.vy = (neighbor.vy || 0) + (dy || 0) * 0.12;
      });
    }

    var nodeGroup = nodesLayer.selectAll('g')
      .data(simNodes)
      .enter().append('g')
        .attr('class', function(d) { return d.__outOfAreaApp ? 'node node-out-of-area-app' : 'node'; })
        .style('cursor', 'pointer')
        .call(d3.drag()
          .on('start', function(event, d) {
            autoFitPending = false;
            if (!event.active) simulation.alphaTarget(0.25).restart();
            d.fx = (typeof d.x === 'number') ? d.x : event.x;
            d.fy = (typeof d.y === 'number') ? d.y : event.y;
          })
          .on('drag', function(event, d) {
            d.fx = event.x;
            d.fy = event.y;
            nudgeNeighbors(d.id, event.dx, event.dy);
          })
          .on('end', function(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = event.x;
            d.fy = event.y;
            pinNodePosition(d);
          })
        )
        .on('click', function(event, d) { showDetail(d); event.stopPropagation(); });

    nodeGroup.append('circle')
      .attr('class', 'node-circle')
      .attr('r', 14)
      .attr('fill', function(d) { return nodeColor(d.type); })
      .attr('fill-opacity', 0.9)
      .attr('stroke', function(d) { return baseNodeStrokeColor(d); })
      .attr('stroke-opacity', function(d) { return baseNodeStrokeOpacity(d); })
      .attr('stroke-width', function(d) { return baseNodeStrokeWidth(d); })
      .attr('stroke-dasharray', function(d) { return baseNodeStrokeDasharray(d); });

    nodeGroup.filter(function(d) { return d.__outOfAreaApp; })
      .append('circle')
      .attr('r', 18)
      .attr('fill', 'none')
      .attr('stroke', '#f59e0b')
      .attr('stroke-opacity', 0.7)
      .attr('stroke-width', 1.4)
      .attr('stroke-dasharray', '3 2');

    nodeGroup.append('text')
      .text(function(d) {
        var label = d.label || d.id || '';
        return label.length > 16 ? label.slice(0, 14) + '...' : label;
      })
      .attr('text-anchor', 'middle')
      .attr('dy', 28)
      .attr('font-size', '10px')
      .attr('fill', 'rgba(255,255,255,0.6)')
      .style('pointer-events', 'none');

    nodeGroup
      .on('mouseenter', function(event, d) {
        d3.select(this).select('.node-circle')
          .attr('stroke', '#fff').attr('stroke-opacity', 0.8).attr('stroke-width', 2);
        link.attr('stroke', function(e) {
          var sid = edgeNodeId(e.source);
          var tid = edgeNodeId(e.target);
          return (sid === d.id || tid === d.id) ? 'rgba(102,126,234,0.7)' : 'rgba(255,255,255,0.08)';
        }).attr('stroke-width', function(e) {
          var sid = edgeNodeId(e.source);
          var tid = edgeNodeId(e.target);
          return (sid === d.id || tid === d.id) ? 2.5 : 1;
        });
      })
      .on('mouseleave', function(event, d) {
        d3.select(this).select('.node-circle')
          .attr('stroke', function() { return baseNodeStrokeColor(d); })
          .attr('stroke-opacity', function() { return baseNodeStrokeOpacity(d); })
          .attr('stroke-width', function() { return baseNodeStrokeWidth(d); })
          .attr('stroke-dasharray', function() { return baseNodeStrokeDasharray(d); });
        link.attr('stroke', 'rgba(255,255,255,0.18)').attr('stroke-width', 1.5);
      });

    svg.on('click', function() { closeDetail(); });

    simulation.on('tick', function() {
      link
        .attr('x1', function(d) { return d.source.x; })
        .attr('y1', function(d) { return d.source.y; })
        .attr('x2', function(d) { return d.target.x; })
        .attr('y2', function(d) { return d.target.y; });
      nodeGroup.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
    });

    simulation.on('end', function() {
      if (autoFitPending) {
        autoFitPending = false;
        fitView(simNodes);
      }
    });
  }

  function showDetail(d) {
    document.getElementById('detailType').textContent = (d.type || 'unknown').toUpperCase();
    document.getElementById('detailLabel').textContent = d.label || d.id || '-';
    var rows = '';
    if (d.id) rows += detailRow('ID', d.id);
    if (d.__outOfAreaApp) rows += detailRow('Hinweis', 'App liegt ausserhalb des Bereichsfilters');
    if (d.group) rows += detailRow('App', d.group);
    if (d.layer) rows += detailRow('Layer', d.layer);
    if (d.subtype) rows += detailRow('Subtype', d.subtype);
    if (d.meta && d.meta.qriPrefix) rows += detailRow('QRI Prefix', d.meta.qriPrefix);
    if (d.meta && Array.isArray(d.meta.qriMatchAppNames) && d.meta.qriMatchAppNames.length) {
      rows += detailRow('QRI Match Apps', d.meta.qriMatchAppNames.join(', '));
    }
    if (d.meta && Array.isArray(d.meta.sourceSystems) && d.meta.sourceSystems.length) {
      rows += detailRow('Source Systems', d.meta.sourceSystems.join(', '));
    }
    if (d.meta && typeof d.meta === 'object') {
      Object.entries(d.meta).slice(0, 5).forEach(function(kv) {
        rows += detailRow(kv[0], JSON.stringify(kv[1]));
      });
    }
    document.getElementById('detailRows').innerHTML = rows;
    document.getElementById('detailPanel').classList.add('show');
  }

  function detailRow(key, val) {
    return '<div class="detail-row"><span class="detail-key">' + escHtml(key) + '</span>'
      + '<span class="detail-val">' + escHtml(String(val)) + '</span></div>';
  }

  function closeDetail() {
    document.getElementById('detailPanel').classList.remove('show');
  }
  document.getElementById('detailClose').addEventListener('click', closeDetail);

  async function loadProjects() {
    try {
      var res = await fetch('/api/projects', { headers: { 'Authorization': 'Bearer ' + token } });
      if (!res.ok) return;
      var projects = await res.json();
      var sel = document.getElementById('projectSelect');
      var urlProject = new URLSearchParams(window.location.search).get('project');
      sel.innerHTML = '<option value="">- alle Projekte -</option>'
        + projects.map(function(p) {
            var custName = p.customer ? ' (' + p.customer.name + ')' : '';
            return '<option value="' + p.id + '"' + (String(p.id) === urlProject ? ' selected' : '') + '>'
              + escHtml(p.name + custName) + '</option>';
          }).join('');
    } catch (e) {}
  }

  async function loadGraph() {
    var loading = document.getElementById('loadingOverlay');
    loading.style.display = 'flex';
    closeDetail();
    clearTidyExpandedForCurrentScope();

    var projectId = document.getElementById('projectSelect').value;
    var url = projectId ? ('/api/graph/project/' + projectId) : '/api/graph/db';

    try {
      var res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
      if (res.status === 401) {
        localStorage.removeItem('auth_access_token');
        window.location.href = '/login.html';
        return;
      }
      if (!res.ok) { throw new Error('HTTP ' + res.status); }
      lastData = await res.json();
      populateLineageFilters(lastData);
      renderGraph(lastData);
      showToast('Graph geladen - ' + (lastData.nodes || []).length + ' Nodes');
    } catch (e) {
      showToast('Fehler: ' + e.message);
      document.getElementById('emptyState').classList.add('show');
    }

    loading.style.display = 'none';
  }

  document.getElementById('loadBtn').addEventListener('click', loadGraph);
  document.getElementById('projectSelect').addEventListener('change', function() {
    autoFitPending = false;
    loadGraph();
  });
  document.getElementById('resetViewBtn').addEventListener('click', function() {
    if (simulation) fitView(simulation.nodes());
    else applyZoomTransform(d3.zoomIdentity, 250);
  });
  document.getElementById('resetLayoutBtn').addEventListener('click', function() {
    clearPinnedLayoutForCurrentScope();
    if (lastData) {
      renderGraph(lastData);
      showToast('Gespeichertes Layout fuer diese Ansicht zurueckgesetzt');
    }
  });
  document.getElementById('typeFilter').addEventListener('change', maybeRenderLastData);
  document.getElementById('appFilter').addEventListener('change', maybeRenderLastData);
  document.getElementById('areaFilter').addEventListener('change', function() {
    if (lastData) populateLineageFilters(lastData);
    maybeRenderLastData();
  });
  document.getElementById('outsideAreaMode').addEventListener('change', maybeRenderLastData);
  document.getElementById('viewMode').addEventListener('change', function() {
    if (document.getElementById('viewMode').value === 'tidy') {
      clearTidyExpandedForCurrentScope();
    }
    maybeRenderLastData();
  });
  document.getElementById('searchInput').addEventListener('input', debounceRender);

  document.getElementById('zoomIn').addEventListener('click', function() {
    autoFitPending = false;
    svg.transition().duration(250).call(zoom.scaleBy, 1.4);
  });
  document.getElementById('zoomOut').addEventListener('click', function() {
    autoFitPending = false;
    svg.transition().duration(250).call(zoom.scaleBy, 1 / 1.4);
  });

  loadProjects().then(loadGraph);
</script>
</body>
</html>
